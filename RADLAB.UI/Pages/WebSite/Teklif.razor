@layout WebSiteLayout

@page "/Teklif"

@inject IJSRuntime js

<section class="section">
    <div class="container">
        <div class="row justify-content-center align-items-center">
            <div class="col-lg-12">
                @if (wizardStep == 0)
                {
                    <input id="tbMail" class="form-control form-control-sm" type="text" @bind-value="BasvuruSahibi" placeholder="Teklif talebinde bulunanın adı soyadı veya ünvanı">
                    <br/>
                    <div class="alert alert-primary" role="alert">
                        Teklif istediğiniz ürünlerin miktarını giriniz
                    </div>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <td width="80%">
                                    Teklif İstenen Ürün
                                </td>
                                <td width="20%" align="center">
                                    Adet
                                </td>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var teklifUrunDTO in DSTeklifUrunDTO)
                            {
                                <tr>
                                    <td>
                                        @teklifUrunDTO.Urun
                                    </td>
                                    <td>
                                        <div class="input-group">
                                            <button class="btn text-primary grid-command" @onclick="@(async () => { await Azalt(teklifUrunDTO); })"><i class="fas fa-minus-circle"></i></button>
                                            <input type="text" readonly class="form-control form-control-sm" style="text-align:center;" @bind-value="teklifUrunDTO.Miktar" />
                                            <button class="btn text-primary grid-command" @onclick="@(async () => { await Artir(teklifUrunDTO); })"><i class="fas fa-plus-circle"></i></button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    <br />
                    <div class="text-center">
                        <button type="submit" class="btn btn-success" @onclick="TeklifYazisi"><i class="bi bi-check-lg"></i>&nbsp;&nbsp;Teklif Yazısı</button>
                    </div>
                }
                else if (wizardStep == 1)
                {
                    <div class="row">
                        <div class="col-md-12 text-center mb-4" id="section-to-print">
                            <div style="background-color:gray; padding:3rem;">
                                <div style="background-color: white; padding: 5rem;">
                                    <div class="row">
                                        <div class="col-md-6 mb-4" style="text-align:left;">
                                            <img src="img/logo.png" alt="" style="width:8rem" />
                                        </div>
                                        <div class="col-md-6 mb-4" style="text-align:right;">
                                            <label style="font-size:1.5rem"><b>Teklif</b></label>
                                        </div>
                                        <div class="col-md-6 mb-4" style="text-align:left;">
                                            <div style="font-size:0.9rem">
                                                <b>RadLab İkincil Standart Dozimetri Laboratuvarı ve Radyasyon Ölçüm Sistemleri Sanayi ve Ticaret A.Ş.</b>
                                                <br />
                                                Ahi Evran OSB Mah. Erkunt Cad. No:3/11 Sincan Ankara
                                                <br />
                                                Sincan VD - 7342105627
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-4 mb-4">
                                        </div>
                                        <div class="col-md-6 mb-4" style="text-align:left;">
                                            <div style="font-size:0.9rem">
                                                <b>Sayın</b>
                                                <br />
                                                <b>@BasvuruSahibi</b>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-4">
                                        </div>
                                        <div class="col-md-12 mb-4">
                                            <table class="table table-bordered" style="font-size:0.9rem">
                                                <thead style="font-weight:bold">
                                                    <tr>
                                                        <td>
                                                            HİZMET
                                                        </td>
                                                        <td align="right">
                                                            BİRİM FİYAT
                                                        </td>
                                                        <td align="right">
                                                            MİKTAR
                                                        </td>
                                                        <td align="right">
                                                            TUTAR
                                                        </td>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @{
                                                        foreach (var kalem in DSTeklifUrunDTO.Where(x => x.Miktar > 0))
                                                        {
                                                            <tr>
                                                                <td>
                                                                    @kalem.Urun
                                                                </td>
                                                                <td align="right">
                                                                    @kalem.Fiyat.ToString("###,##0.#0₺")
                                                                </td>
                                                                <td align="right">
                                                                    @kalem.Miktar
                                                                </td>
                                                                <td align="right">
                                                                    @((kalem.Miktar * kalem.Fiyat).ToString("###,##0.#0₺"))
                                                                </td>
                                                            </tr>
                                                        }
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="col-md-6" style="text-align:left; padding-top:2rem;">
                                            <b>Teklif Tarihi: </b>@(DateTime.Now.Date.ToString("dd.MM.yyyy"))
                                            <br/>
                                            <b>Teklifimiz 1 (bir) hafta geçerlidir.</b>
                                        </div>
                                        <div class="col-md-6" style="text-align:right;">
                                            @{
                                                var genelToplam = DSTeklifUrunDTO.Where(x => x.Miktar > 0).Sum(x => (x.Miktar * x.Fiyat));

                                                var kdvler = DSTeklifUrunDTO.Where(x => x.Miktar > 0).GroupBy(t => t.KdvOrani)
                                                .Select(t => new
                                                {
                                                    KdvOrani = t.Key,
                                                    KdvTutari = Math.Round(t.Sum(ta => (ta.Miktar * ta.Fiyat) - (ta.Miktar * ta.Fiyat * 100 / (100 + ta.KdvOrani))), 2)
                                                }).ToList();

                                                var toplamKdv = kdvler.Sum(x => x.KdvTutari);

                                                var toplam = genelToplam - toplamKdv;
                                            }

                                            <table style="display:inline; font-size:0.9rem" cellpadding="4">
                                                <tr>
                                                    <td>
                                                        <b>TOPLAM:</b>
                                                    </td>
                                                    <td>
                                                        @toplam.ToString("###,##0.#0₺");
                                                    </td>
                                                </tr>
                                                @foreach (var kdv in kdvler)
                                                {
                                                    <tr>
                                                        <td>
                                                            <b>KDV (%@kdv.KdvOrani.ToString("#.##")):</b>
                                                        </td>
                                                        <td>
                                                            @kdv.KdvTutari.ToString("###,##0.#0₺");
                                                        </td>
                                                    </tr>
                                                }
                                                <tr>
                                                    <td>
                                                        <b>GENEL TOPLAM:</b>
                                                    </td>
                                                    <td>
                                                        @genelToplam.ToString("###,##0.#0₺");
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12" style="text-align:center;">
                            <button type="button" class="btn btn-primary" @onclick="Geri"><i class="bi bi-chevron-left"></i>&nbsp;&nbsp;Geri</button>
                            <a class="btn btn-primary" href="javascript:void()" @onclick="Yazdir">Teklifi Yazdır</a>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</section>

@code
{
    [Inject] protected ICihazService cihazService { get; set; }

    List<TeklifUrunDTO> DSTeklifUrunDTO = new List<TeklifUrunDTO>();

    int wizardStep = 0;
    string BasvuruSahibi = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var DSCihazSatisList = await cihazService.GetCihazSatisList();

            var kalibrasyonDTO = new TeklifUrunDTO()
                {
                    Id = 0,
                    Urun = "Kalibrasyon Hizmeti",
                    Fiyat = DSCihazSatisList[0].KalibrasyonUcreti,
                    KdvOrani = DSCihazSatisList[0].KdvOrani
                };

            DSTeklifUrunDTO.Add(kalibrasyonDTO);

            foreach (var cihazSatisDTO in DSCihazSatisList)
            {
                var teklifUrunDTO = new TeklifUrunDTO()
                    {
                        Id = cihazSatisDTO.Id,
                        Urun = cihazSatisDTO.Marka + " " + cihazSatisDTO.Model + " Cihaz Satışı",
                        Fiyat = cihazSatisDTO.Fiyat,
                        KdvOrani = cihazSatisDTO.KdvOrani
                    };

                DSTeklifUrunDTO.Add(teklifUrunDTO);
            }

            await InvokeAsync(StateHasChanged);
        }
    }

    async Task Artir(TeklifUrunDTO dto)
    {
        dto.Miktar++;

        await InvokeAsync(StateHasChanged);
    }

    async Task Azalt(TeklifUrunDTO dto)
    {
        if (dto.Miktar > 0) dto.Miktar--;

        await InvokeAsync(StateHasChanged);
    }

    async Task TeklifYazisi()
    {
        if (string.IsNullOrEmpty(BasvuruSahibi))
        {
            await js.InvokeVoidAsync("SweetMessage", "Uyarı", "Teklif almak isteyenin adı soyadı veya ünvanını giriniz", "error");
            return;
        }

        var toplamMkitar = DSTeklifUrunDTO.Sum(x => x.Miktar);

        if (toplamMkitar <= 0)
        {
            await js.InvokeVoidAsync("SweetMessage", "Uyarı", "Teklif almak istediğiniz ürünlerin miktarını giriniz", "error");
            return;
        }

        wizardStep = 1;

        await InvokeAsync(StateHasChanged);
    }

    async Task Geri()
    {
        wizardStep = 0;

        await InvokeAsync(StateHasChanged);
    }

    async Task Yazdir()
    {
        await js.InvokeVoidAsync("printDiv");
    }
}