@layout WebSiteLayout

@page "/Cihaz/{Id}"

@using Newtonsoft.Json

@inject IJSRuntime js
@inject ILocalStorageService localStorageService
@inject NavigationManager navManager

<style>
    .carousel-indicators [data-bs-target] {
        background-color:gray;
    }
</style>

<section class="section">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <a href="/OnlineSatis" class="btn btn-outline-primary">Tüm Cihazlar</a>
                <br />
                <br />
            </div>
            <div class="col-md-6" style="text-align:right;">
                @if (string.IsNullOrEmpty(currentDTO.KullanmaKlavuzuDosyaAdi) == false)
                {
                    <a href=@("data:application/pdf;base64," + currentDTO.KullanmaKlavuzuIcerik) download=@currentDTO.KullanmaKlavuzuDosyaAdi>Kullanma Klavuzunu İndir</a>
                    <br />
                    <br />
                }
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <div id="myCarousel" class="carousel slide mb-6" data-bs-ride="carousel" style="height:24rem; text-align:center; align-content:center;">
                            <div class="carousel-indicators">
                                @{
                                    int i = 0;
                                }

                                @foreach(var item in currentDTO.CihazResimleri)
                                {
                                    <button type="button" data-bs-target="#myCarousel" data-bs-slide-to=@i aria-label=@("Slide " + i.ToString()) class="active" aria-current="true"></button>
                                    i++;
                                }
                            </div>
                            <div class="carousel-inner">
                                @{
                                    int k = 0;
                                }

                                @foreach (var item in currentDTO.CihazResimleri)
                                {
                                    <div class=@(k == 0 ? "carousel-item active" : "carousel-item")>
                                        <a href="javascript:void()" @onclick="Onizle">
                                            <img loading="lazy" decoding="async" src=@("data:image/" + item.Uzanti + ";base64," + item.DosyaBuyuk) type=@("image/" + item.Uzanti) style="height:18rem; max-width:18rem;">
                                        </a>
                                    </div>

                                    k++;
                                }
                            </div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#myCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true" style="background-image:none;">
                                    <i class="fas fa-chevron-left" style="color:black; font-size:2rem;"></i>
                                </span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#myCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true" style="background-image:none;">
                                    <i class="fas fa-chevron-right" style="color:black; font-size:2rem;"></i>
                                </span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <div style="height:24rem; text-align:center; align-content:center;">
                            <h1 class="mb-4">@(currentDTO.Marka + " " + currentDTO.Model)</h1>
                            <p class="mb-4">@currentDTO.Fiyat.ToString("###,##0.#0₺")</p>
                            @if (currentDTO.StokMiktari > currentDTO.KritikStok)
                            {
                                <button class="btn btn-sm btn-outline-primary" @onclick="@(async () => { await SepeteEkle(currentDTO); })"><i class="fas fa-shopping-cart"></i>&nbsp;&nbsp;Sepete Ekle</button>
                            }
                            else
                            {
                                <button class="btn btn-sm btn-outline-danger" disabled>&nbsp;&nbsp;Stokta Yok</button>
                            }
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        @((MarkupString)currentDTO.Ozellik)
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<button id="popupOnizleAc" type="button" data-bs-toggle="modal" data-bs-target="#popupOnizle" style="visibility:hidden;">
</button>

<div class="modal fade" id="popupOnizle" tabindex="-1" aria-labelledby="popupOnizleLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen" style="width:100vw; max-width:100vw; height:100%">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="myCarouselBig" class="carousel slide" data-bs-ride="carousel" style="text-align:center; align-content:center;">
                    <div class="carousel-indicators">
                        @{
                            int ii = 0;
                        }

                        @foreach (var item in currentDTO.CihazResimleri)
                        {
                            <button type="button" data-bs-target="#myCarousel" data-bs-slide-to=@ii aria-label=@("Slide " + ii.ToString()) class="active" aria-current="true"></button>
                            ii++;
                        }
                    </div>
                    <div class="carousel-inner">
                        @{
                            int kk = 0;
                        }

                        @foreach (var item in currentDTO.CihazResimleri)
                        {
                            <div class=@(kk == 0 ? "carousel-item active" : "carousel-item") style="height: calc(100vh - 80px); align-content: center;">
                                <a href="javascript:void()" @onclick="Onizle">
                                    <img loading="lazy" decoding="async" src=@("data:image/" + item.Uzanti + ";base64," + item.DosyaBuyuk) type=@("image/" + item.Uzanti)>
                                </a>
                            </div>

                            kk++;
                        }
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#myCarouselBig" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true" style="background-image:none;">
                            <i class="fas fa-chevron-left" style="color:black; font-size:4rem;"></i>
                        </span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#myCarouselBig" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true" style="background-image:none;">
                            <i class="fas fa-chevron-right" style="color:black; font-size:4rem;"></i>
                        </span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            </div>
            @* <div class="modal-footer">
                <button id="popupOnizleKapat" type="button" class="btn btn-primary btn-sm" data-bs-dismiss="modal">Kapat</button>
            </div> *@
        </div>
    </div>
</div>

@code
{
    [Parameter]
    public string Id { get; set; }

    [Inject] protected ICihazService cihazService { get; set; }

    CihazDTO currentDTO = new CihazDTO() { CihazResimleri = new List<CihazResimDTO>() };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            currentDTO = await cihazService.GetCihaz(Convert.ToInt32(Id));

            await InvokeAsync(StateHasChanged);
        }
    }

    async Task Onizle()
    {
        await js.InvokeVoidAsync("bsPopupAc", "popupOnizle");
    }

    async Task SepeteEkle(CihazDTO dto)
    {
        if (navManager.Uri.StartsWith("http://radlab.com.tr") || navManager.Uri.StartsWith("https://radlab.com.tr"))
        {
            await js.InvokeVoidAsync("SweetMessage", "Bilgi", "Cihaz satış bölümü yapım aşamasındadır. Çok yakında hizmete açılacaktır.", "warning");
            return;
        }

        string RadlabCihazSatisList = await localStorageService.GetItemAsStringAsync("RadlabCihazSatisList");

        RadlabCihazSatisList = RadlabCihazSatisList.Replace("\\u0022", "").Replace("\"", "");

        var CihazSatisList = new List<CihazSatisDTO>();

        try
        {
            CihazSatisList = JsonConvert.DeserializeObject<List<CihazSatisDTO>>(RadlabCihazSatisList);
        }
        catch
        {

        }

        var existCihaz = CihazSatisList.SingleOrDefault(x => x.Id == dto.Id);

        if (existCihaz == null)
        {
            CihazSatisList.Add(new CihazSatisDTO() { Id = dto.Id, Miktar = 1 });
        }
        else
        {
            existCihaz.Miktar++;
        }

        RadlabCihazSatisList = JsonConvert.SerializeObject(CihazSatisList);

        await localStorageService.SetItemAsync("RadlabCihazSatisList", RadlabCihazSatisList);

        await InvokeAsync(StateHasChanged);

        await js.InvokeVoidAsync("SweetToast", "Cihaz sepete eklendi", "success");
    }
}